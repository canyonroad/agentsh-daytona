# agentsh server configuration for Daytona sandbox
# Updated for agentsh v0.10.4
# Policy-based security mode (relies on default.yaml for enforcement)

server:
  http:
    addr: "127.0.0.1:18080"
    read_timeout: "30s"
    write_timeout: "60s"
    max_request_size: "10MB"
  grpc:
    enabled: true
    addr: "127.0.0.1:9090"

auth:
  type: "none"

logging:
  level: "info"
  format: "json"
  output: "stderr"
  rotation:
    max_size_mb: 100
    max_age_days: 7
    compress: true

sessions:
  base_dir: "/var/lib/agentsh/sessions"
  max_sessions: 100
  default_timeout: "1h"
  default_idle_timeout: "15m"
  cleanup_interval: "5m"

audit:
  enabled: true
  format: "jsonl"
  storage:
    sqlite_path: "/var/lib/agentsh/events.db"
  retention:
    max_age_days: 90

# =============================================================================
# SECURITY CONFIGURATION (v0.10.4)
# =============================================================================

# Simplified security - rely on policy rules in default.yaml
# v0.8.1: Added execve interception with depth-aware policies
# v0.8.9: Added env_inject for operator-controlled variable injection
# v0.9.0: Added dns_redirect and connect_redirect capabilities
# v0.9.3: Agent wrap, cross-platform exec interception
# v0.9.5: Landlock filesystem enforcement (kernel 5.13+)
# v0.9.9: FUSE filesystem interception with deferred mounting
# v0.10.0: BASH_ENV injection for builtin disabling, Landlock execution paths

sandbox:
  enabled: true
  allow_degraded: true

  limits:
    max_memory_mb: 4096
    max_cpu_percent: 100
    max_processes: 256

  network:
    enabled: true
    intercept_mode: "all"
    proxy_listen_addr: "127.0.0.1:0"

  # v0.8.1: Execve interception - disabled for container environments
  # Daytona's container seccomp profile prevents installing custom seccomp filters
  # Enable this on hosts with full kernel support for syscall interception
  # Note: Bash builtins (kill, enable, etc.) are handled by BASH_ENV instead
  # seccomp:
  #   execve:
  #     enabled: true

  # v0.9.9: FUSE filesystem interception with deferred mounting for containers
  # Use /dev/fuse as marker (daytona user is in fuse group, no sudo needed)
  fuse:
    enabled: true
    deferred: true
    deferred_marker_file: "/dev/fuse"
    audit:
      enabled: true
      mode: "soft_delete"
      trash_path: "/home/daytona/.agentsh_trash"

  # v0.9.5: Landlock filesystem enforcement - restrict binary execution paths
  landlock:
    enabled: true
    allow_execute:
      - /usr/bin
      - /bin
      - /usr/local/bin
      - /usr/sbin
      - /sbin
      - /usr/lib
      - /lib
    network:
      allow_connect_tcp: true
      allow_bind_tcp: true

  # v0.8.9: Operator-controlled environment variable injection
  # These bypass env_policy filtering since they're operator-controlled
  env_inject:
    # Ensure agentsh server is always reachable
    AGENTSH_SERVER: "http://127.0.0.1:18080"
    # Activate bash_startup.sh to disable dangerous builtins (kill, enable, ulimit, etc.)
    BASH_ENV: "/usr/lib/agentsh/bash_startup.sh"
    # Daytona workspace variables (operator-controlled)
    # DAYTONA_WS_DIR: "/home/daytona/workspace"

proxy:
  mode: "embedded"
  port: 0
  providers:
    anthropic: "https://api.anthropic.com"
    openai: "https://api.openai.com"

dlp:
  mode: "redact"
  patterns:
    email: true
    phone: true
    credit_card: true
    ssn: true
    api_keys: true
  custom_patterns:
    - name: openai_key
      display: OPENAI_KEY
      regex: "sk-[a-zA-Z0-9]{48,}"
    - name: anthropic_key
      display: ANTHROPIC_KEY
      regex: "sk-ant-[a-zA-Z0-9-]{95,}"
    - name: aws_access_key
      display: AWS_KEY
      regex: "AKIA[0-9A-Z]{16}"
    - name: github_pat
      display: GITHUB_TOKEN
      regex: "ghp_[a-zA-Z0-9]{36}"
    - name: github_oauth
      display: GITHUB_OAUTH
      regex: "gho_[a-zA-Z0-9]{36}"
    - name: jwt_token
      display: JWT
      regex: "eyJ[a-zA-Z0-9_-]*\\.eyJ[a-zA-Z0-9_-]*\\.[a-zA-Z0-9_-]*"
    - name: private_key
      display: PRIVATE_KEY
      regex: "-----BEGIN [A-Z]+ PRIVATE KEY-----"
    - name: slack_token
      display: SLACK_TOKEN
      regex: "xox[baprs]-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24}"
    - name: daytona_api_key
      display: DAYTONA_KEY
      regex: "dtn_[a-zA-Z0-9]{64}"
    - name: google_api_key
      display: GOOGLE_KEY
      regex: "AIza[0-9A-Za-z\\-_]{35}"

policies:
  dir: "/etc/agentsh/policies"
  default: "default"
  project_markers:
    - ".git"
    - "package.json"
    - "Cargo.toml"
    - "go.mod"
    - "pyproject.toml"
    - "requirements.txt"

approvals:
  enabled: false
  mode: "async"
  timeout: "5m"

metrics:
  enabled: true
  path: "/metrics"

health:
  path: "/health"
  readiness_path: "/ready"

development:
  disable_auth: true
  verbose_errors: false
